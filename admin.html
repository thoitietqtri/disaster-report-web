<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ADMIN — DUYỆT BÁO CAO, TỔNG HỢP THIÊN TAI</title>
  <style>
    :root{
      --bg:#f6f8ff; --card:#fff; --txt:#0f172a; --muted:#64748b; --pri:#1d4ed8;
      --ok:#16a34a; --warn:#d97706; --grid:#e2e8f0; --shadow:0 10px 30px -14px rgba(2,6,23,.25);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font:15px/1.55 system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--txt)}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--grid);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin-bottom:16px}
    h1{margin:0 0 6px 0;font-size:22px}
    .muted{color:var(--muted);font-size:13px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select,button{padding:9px 10px;border:1px solid var(--grid);border-radius:10px}
    input[type=date]{padding:8px 10px}
    button{cursor:pointer;font-weight:600}
    .btn{background:var(--pri);color:#fff;border:none}
    .btn.secondary{background:#fff;color:var(--pri);border:1px solid var(--pri)}
    .btn.ok{background:var(--ok);color:#fff;border:none}
    .btn.warn{background:var(--warn);color:#fff;border:none}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{border-bottom:1px solid var(--grid);padding:10px;text-align:left;vertical-align:top}
    th{background:#f8fafc;font-size:13px;color:#0f172a}
    .badge{display:inline-block;padding:2px 8px;border:1px solid var(--grid);border-radius:999px;font-size:12px;background:#f8fafc}
    .pill{padding:4px 8px;border-radius:999px;font-size:12px}
    .pill.pending{background:#fff7ed;color:#9a3412;border:1px solid #fed7aa}
    .pill.approved{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0}
    .pill.rejected{background:#fef2f2;color:#991b1b;border:1px solid #fecaca}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .toast{position:fixed;right:18px;bottom:18px;background:#fff;border:1px solid var(--grid);padding:10px 12px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,.25)}
    dialog{border:none;border-radius:16px;max-width:92vw;width:980px}
    dialog::backdrop{background:rgba(0,0,0,.35)}
    .modal-body{max-height:70vh;overflow:auto;border:1px solid var(--grid);border-radius:12px;padding:8px;background:#fff}
    .payload-table td{border:1px solid #e5e7eb;padding:6px}
    .right{margin-left:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ADMIN — DUYỆT BÁO CÁO, TỔNG HỢP THIỆT HẠI</h1>
      <div class="muted">Xem/lọc báo cáo 78 xã, xem payload, duyệt, và tổng hợp thiệt hại (Excel/JSON).</div>
    </div>

    <!-- Đăng nhập -->
    <div class="card" id="loginCard">
      <div class="row">
        <input id="email" placeholder="admin@qtri.vn" style="min-width:260px"/>
        <input id="password" type="password" placeholder="Mật khẩu"/>
        <button class="btn" id="btnLogin">Đăng nhập</button>
      </div>
      <div class="muted" style="margin-top:6px">Tài khoản phải thuộc danh sách admin (allowlist).</div>
    </div>

    <!-- Thanh công cụ admin -->
    <div class="card" id="adminCard" style="display:none">
      <div class="row">
        <span class="badge" id="who"></span>
        <button class="btn secondary" id="btnLogout">Đăng xuất</button>
        <span class="right"></span>
        <input id="kw" placeholder="Từ khóa (tiêu đề/mã xã/tên xã)" style="min-width:260px"/>
        <label class="muted">Từ ngày</label><input type="date" id="d1">
        <label class="muted">Đến ngày</label><input type="date" id="d2">
        <select id="communeFilter"><option value="">-- Tất cả xã/phường --</option></select>
        <label class="row" style="gap:6px"><input type="checkbox" id="latestOnly" checked><span class="muted">Chỉ hiện báo cáo mới nhất mỗi xã</span></label>
        <button class="btn" id="btnReload">Tải danh sách</button>
      </div>
    </div>

    <!-- Danh sách báo cáo -->
    <div class="card" id="listCard" style="display:none">
      <div class="row" style="justify-content:flex-end; gap:8px; margin-bottom:10px">
        <label class="row" style="gap:6px;margin-right:8px"><input type="checkbox" id="approvedOnly"><span class="muted">Chỉ tổng hợp báo cáo đã duyệt</span></label>
        <button class="btn secondary" id="btnExportSummaryXLSX">Tổng hợp thiệt hại (Excel)</button>
        <button class="btn secondary" id="btnExportSummaryJSON">Tải tonghop.json</button>
        <small class="muted" id="sumInfo"></small>
      </div>

      <table id="tbl">
        <thead>
          <tr>
            <th style="width:160px">Thời gian</th>
            <th style="width:120px">Mã xã/Phường</th>
            <th style="width:220px">Tên xã/Phường</th>
            <th>Tiêu đề</th>
            <th style="width:100px">Kích thước</th>
            <th style="width:260px">Hành động</th>
          </tr>
        </thead>
        <tbody id="rows"><tr><td colspan="6" class="muted">Chưa có dữ liệu…</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Modal xem chi tiết -->
  <dialog id="dlg">
    <form method="dialog" style="margin:0">
      <div class="card" style="box-shadow:none">
        <div class="row">
          <b id="dlgTitle">Chi tiết báo cáo</b>
          <span class="right"></span>
          <button class="btn secondary">Đóng</button>
        </div>
      </div>
      <div class="modal-body"><div id="payloadHost"></div></div>
      <div class="card" style="box-shadow:none">
        <div class="toolbar">
          <button type="button" class="btn secondary" id="dlgExportJson">Xuất JSON</button>
          <button type="button" class="btn secondary" id="dlgExportXlsx">Xuất Excel (.xlsx)</button>
          <span class="right"></span>
          <button type="button" class="btn ok" id="dlgApprove">Duyệt</button>
          <button type="button" class="btn warn" id="dlgReject">Không duyệt</button>
        </div>
      </div>
    </form>
  </dialog>

  <!-- Supabase & SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./xlsx.full.min.js"></script>
  <!-- XlsxPopulate để giữ format/công thức nếu có Baocaogoc.xlsx -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx-populate/browser/xlsx-populate.min.js"></script>

  <script>
    // ==== Đợi XLSX sẵn sàng (sửa lỗi tổng hợp khi thư viện chưa kịp nạp) ====
    function waitForXLSX(maxMs=5000){
      return new Promise((resolve,reject)=>{
        if (window.XLSX) return resolve();
        const s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
        s.onload=()=>resolve();
        s.onerror=()=>reject(new Error('Không tải được XLSX từ CDN'));
        document.head.appendChild(s);
        const to=setTimeout(()=>{ if(!window.XLSX) reject(new Error('XLSX chưa sẵn sàng')); }, maxMs);
      });
    }

    const SUPABASE_URL  = "https://iwrktrjjpbbogazpohrq.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml3cmt0cmpqcGJib2dhenBvaHJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczODIwMzgsImV4cCI6MjA3Mjk1ODAzOH0.Hd12I5UeS6lrE9FSz4bkrM6HaWs-03-vtth5U6dLmB4";
    const ADMIN_EMAILS  = ["admin@qtri.vn","duyet@qtri.vn"];

    if(!window.supabase){ alert('Không tải được Supabase JS từ CDN.'); }
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    const $ = (id)=>document.getElementById(id);
    function toast(msg){ let el=document.querySelector('.toast'); if(!el){el=document.createElement('div'); el.className='toast'; document.body.appendChild(el);} el.textContent=msg; clearTimeout(window.__tt); window.__tt=setTimeout(()=>{ el.remove(); },2600); }
    function fmtBytes(n){ try{ return new Blob([JSON.stringify(n)]).size+' B'; }catch{ return '-'; } }
    function vn(s){ if(!s) return ''; return s.toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[đĐ]/g,'d').toLowerCase(); }

    // ====== Danh mục xã/phường từ profiles ======
    let communeByCode = new Map();  // code  -> name
    let communeByUser = new Map();  // user_id -> name
    async function loadReference(){
      const { data: profiles, error } = await supabase.from('profiles').select('user_id,commune_code,commune_name').limit(5000);
      if(error){ console.error('loadReference error', error); }
      communeByCode.clear(); communeByUser.clear();
      (profiles||[]).forEach(r=>{
        if(r.user_id && r.commune_name) communeByUser.set(r.user_id, r.commune_name);
        if(r.commune_code && r.commune_name && !communeByCode.has(r.commune_code)) communeByCode.set(r.commune_code, r.commune_name);
      });
      const sel = $('communeFilter'); sel.innerHTML = '<option value="">-- Tất cả xã/phường --</option>';
      Array.from(communeByCode.entries()).sort((a,b)=>a[1].localeCompare(b[1],'vi')).forEach(([code,name])=>{
        const opt=document.createElement('option'); opt.value=code; opt.textContent=`${name} (${code})`; sel.appendChild(opt);
      });
    }

    // ====== Đăng nhập ======
    $('btnLogin').onclick = async ()=>{
      try{
        const email=$('email').value.trim(); const password=$('password').value.trim();
        if(!email||!password){ alert('Vui lòng nhập email và mật khẩu'); return; }
        const btn=$('btnLogin'); const old=btn.textContent; btn.disabled=true; btn.textContent='Đang xử lý...';
        let to=setTimeout(()=>alert('Đăng nhập chậm. Kiểm tra mạng/CDN/ANON KEY.'), 10000);
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        clearTimeout(to);
        if(error){ alert('Đăng nhập lỗi: '+error.message); btn.disabled=false; btn.textContent=old; return; }
        if(!ADMIN_EMAILS.includes(email)){ alert('Tài khoản này chưa có quyền admin.'); await supabase.auth.signOut(); btn.disabled=false; btn.textContent=old; return; }
        $('who').textContent = 'Đang đăng nhập: '+email;
        $('loginCard').style.display='none'; $('adminCard').style.display='block'; $('listCard').style.display='block';
        await loadReference(); await reload(); toast('Đăng nhập thành công');
        btn.disabled=false; btn.textContent=old;
      }catch(e){
        alert('Lỗi khi đăng nhập: '+(e.message||e)); const btn=$('btnLogin'); btn.disabled=false; btn.textContent='Đăng nhập';
      }
    };
    $('btnLogout').onclick = async ()=>{ await supabase.auth.signOut(); location.reload(); };

    // ====== Tải danh sách báo cáo (bảng) ======
    $('btnReload').onclick = reload;
    async function reload(){
      const kw = vn($('kw').value || '');
      const d1 = $('d1').value; const d2 = $('d2').value;
      const communeCode = $('communeFilter').value;
      const latestOnly = $('latestOnly').checked;

      let q = supabase.from('reports')
        .select('id, created_at, title, commune_code, user_id, payload, status')
        .order('created_at',{ascending:false})
        .limit(2000);
      if(d1) q = q.gte('created_at', d1+"T00:00:00");
      if(d2) q = q.lte('created_at', d2+"T23:59:59");
      if(communeCode) q = q.eq('commune_code', communeCode);

      const { data, error } = await q;
      if(error){ alert('Lỗi tải reports: '+error.message); return; }
      let rows = data || [];

      if(kw){
        rows = rows.filter(r=>{
          const name = communeByUser.get(r.user_id)||communeByCode.get(r.commune_code)||'';
          const title = r.title || ''; const code = r.commune_code || '';
          return vn(title).includes(kw) || vn(code).includes(kw) || vn(name).includes(kw);
        });
      }

      if (latestOnly){
        const pick = new Map();
        for (const r of rows){ const code = r.commune_code || '__NONE__'; if (!pick.has(code)) pick.set(code, r); }
        rows = Array.from(pick.values()).sort((a,b)=> (a.created_at < b.created_at ? 1 : -1));
      }

      renderList(rows);
    }

    function renderList(rows){
      const tbody = $('rows'); tbody.innerHTML='';
      if(!rows.length){
        const tr=document.createElement('tr'); const td=document.createElement('td');
        td.colSpan=6; td.textContent='Không có báo cáo nào phù hợp bộ lọc.'; td.className='muted';
        tr.appendChild(td); tbody.appendChild(tr); return;
      }
      for (const r of rows){
        const tr=document.createElement('tr');

        const tdTime=document.createElement('td');
        tdTime.textContent = new Date(r.created_at).toLocaleString('vi-VN');
        tr.appendChild(tdTime);

        const tdCode=document.createElement('td');
        tdCode.textContent = r.commune_code || '-';
        tr.appendChild(tdCode);

        const tdName=document.createElement('td');
        tdName.textContent = communeByUser.get(r.user_id)||communeByCode.get(r.commune_code)||'-';
        tr.appendChild(tdName);

        const tdTitle=document.createElement('td');
        tdTitle.textContent = r.title || '(không tiêu đề)';
        tr.appendChild(tdTitle);

        const tdSize=document.createElement('td');
        tdSize.textContent = fmtBytes(r.payload);
        tr.appendChild(tdSize);

        const tdAct=document.createElement('td'); tdAct.className='toolbar';
        const btnView=document.createElement('button'); btnView.className='btn secondary'; btnView.textContent='Xem chi tiết'; btnView.onclick=()=>openDetail(r); tdAct.appendChild(btnView);
        const btnJSON=document.createElement('button'); btnJSON.className='btn secondary'; btnJSON.textContent='Xuất JSON'; btnJSON.onclick=()=>exportJSON(r); tdAct.appendChild(btnJSON);
        const btnXLSX=document.createElement('button'); btnXLSX.className='btn secondary'; btnXLSX.textContent='Xuất Excel'; btnXLSX.onclick=()=>exportXLSX(r); tdAct.appendChild(btnXLSX);
        const pill=document.createElement('span'); pill.className='pill '+(r.status||'pending'); pill.textContent = r.status||'pending'; tdAct.appendChild(pill);
        const btnOk=document.createElement('button'); btnOk.className='btn ok'; btnOk.textContent='Duyệt'; btnOk.onclick=()=>updateStatus(r.id,'approved'); tdAct.appendChild(btnOk);
        const btnNo=document.createElement('button'); btnNo.className='btn warn'; btnNo.textContent='Không duyệt'; btnNo.onclick=()=>updateStatus(r.id,'rejected'); tdAct.appendChild(btnNo);
        tr.appendChild(tdAct);

        tbody.appendChild(tr);
      }
    }

    let currentDetail = null;
    async function openDetail(r){
      currentDetail = r;
      const n = communeByUser.get(r.user_id)||communeByCode.get(r.commune_code)||r.commune_code||'';
      $('dlgTitle').textContent = n+' — '+new Date(r.created_at).toLocaleString('vi-VN');
      const host=$('payloadHost'); host.innerHTML='';
      host.appendChild(renderPayload(r.payload));
      document.querySelector('#dlg').showModal();
    }

    // ===== renderPayload: ưu tiên aoa, nếu chỉ có cells thì dựng lưới từ địa chỉ =====
    function renderPayload(p){
      const wrap=document.createElement('div');
      const table=document.createElement('table'); table.className='payload-table';

      if (p && Array.isArray(p.aoa) && p.aoa.length){
        p.aoa.forEach(row=>{
          const tr=document.createElement('tr');
          row.forEach(val=>{ const td=document.createElement('td'); td.textContent=(val==null?'':String(val)); tr.appendChild(td); });
          table.appendChild(tr);
        });
        wrap.appendChild(table); return wrap;
      }

      if (p && p.cells && typeof p.cells==='object' && !Array.isArray(p.cells)){
        try{
          const addrs = Object.keys(p.cells);
          if (addrs.length <= 5){
            const trh=document.createElement('tr'); ['Ô','Giá trị'].forEach(h=>{ const td=document.createElement('td'); td.textContent=h; td.style.fontWeight='700'; trh.appendChild(td); }); table.appendChild(trh);
            addrs.sort().forEach(a=>{ const tr=document.createElement('tr'); const c1=document.createElement('td'); c1.textContent=a; const c2=document.createElement('td'); c2.textContent=(p.cells[a]==null?'':String(p.cells[a])); tr.appendChild(c1); tr.appendChild(c2); table.appendChild(tr); });
            wrap.appendChild(table); return wrap;
          }
          const pos = addrs.map(addr=>{ const rc=XLSX.utils.decode_cell(addr); return {r:rc.r, c:rc.c, v:p.cells[addr]}; });
          const maxR = Math.max(...pos.map(x=>x.r));
          const maxC = Math.max(...pos.map(x=>x.c));
          const grid = Array.from({length:maxR+1},()=>Array.from({length:maxC+1},()=>''));
          pos.forEach(x=>{ grid[x.r][x.c] = (x.v==null?'':String(x.v)); });
          grid.forEach(row=>{ const tr=document.createElement('tr'); row.forEach(val=>{ const td=document.createElement('td'); td.textContent=val; tr.appendChild(td); }); table.appendChild(tr); });
          wrap.appendChild(table); return wrap;
        }catch(e){
          console.error('renderPayload cells->aoa error', e);
          const trh=document.createElement('tr'); ['Ô','Giá trị'].forEach(h=>{ const td=document.createElement('td'); td.textContent=h; td.style.fontWeight='700'; trh.appendChild(td); }); table.appendChild(trh);
          Object.entries(p.cells).forEach(([k,v])=>{ const tr=document.createElement('tr'); const c1=document.createElement('td'); c1.textContent=k; const c2=document.createElement('td'); c2.textContent=(v==null?'':String(v)); tr.appendChild(c1); tr.appendChild(c2); table.appendChild(tr); });
          wrap.appendChild(table); return wrap;
        }
      }

      if (p && typeof p==='object' && !Array.isArray(p)){
        const trh=document.createElement('tr'); ['Ô','Giá trị'].forEach(h=>{ const td=document.createElement('td'); td.textContent=h; td.style.fontWeight='700'; trh.appendChild(td); }); table.appendChild(trh);
        Object.entries(p).forEach(([k,v])=>{ const tr=document.createElement('tr'); const c1=document.createElement('td'); c1.textContent=k; const c2=document.createElement('td'); c2.textContent=(v==null?'':String(v)); tr.appendChild(c1); tr.appendChild(c2); table.appendChild(tr); });
      } else {
        const tr=document.createElement('tr'); const td=document.createElement('td'); td.textContent='Payload rỗng hoặc không hợp lệ.'; tr.appendChild(td); table.appendChild(tr);
      }

      wrap.appendChild(table); return wrap;
    }

    // ===== Export & Update cho từng báo cáo =====
    function exportJSON(r){
      const blob=new Blob([JSON.stringify(r.payload,null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`payload_${r.id}.json`; a.click();
    }
    function exportXLSX(r){
      if(!window.XLSX){ alert('Thiếu XLSX'); return; }
      let aoa=(r.payload&&Array.isArray(r.payload.aoa)&&r.payload.aoa.length)?r.payload.aoa:null;
      if(!aoa&&r.payload&&r.payload.cells){
        const pos=Object.keys(r.payload.cells).map(addr=>{ const rc=XLSX.utils.decode_cell(addr); return {r:rc.r,c:rc.c,v:r.payload.cells[addr]}; });
        if(pos.length){
          const maxR=Math.max(...pos.map(p=>p.r)), maxC=Math.max(...pos.map(p=>p.c));
          aoa=Array.from({length:maxR+1},()=>Array.from({length:maxC+1},()=>''));
          pos.forEach(p=>{ aoa[p.r][p.c]=p.v==null?'':String(p.v); });
        } else { aoa=[['(trống)']]; }
      }
      if(!aoa) aoa=[['(trống)']];
      const wb=XLSX.utils.book_new(); const ws=XLSX.utils.aoa_to_sheet(aoa);
      ws['!cols']=Array.from({length:Math.max(...aoa.map(r=>r.length))||1},()=>({wch:20}));
      XLSX.utils.book_append_sheet(wb,ws,'Maubaocao');
      XLSX.writeFile(wb,`baocao_${r.id}.xlsx`);
    }

    $('dlgExportJson').onclick=()=>{ if(currentDetail) exportJSON(currentDetail); };
    $('dlgExportXlsx').onclick=()=>{ if(currentDetail) exportXLSX(currentDetail); };
    $('dlgApprove').onclick=()=>{ if(currentDetail) updateStatus(currentDetail.id,'approved',true); };
    $('dlgReject').onclick=()=>{ if(currentDetail) updateStatus(currentDetail.id,'rejected',true); };

    async function updateStatus(id,status,closeModal=false){
      try{
        const { error } = await supabase.from('reports').update({ status }).eq('id',id);
        if(error){ alert('Cập nhật thất bại (thiếu cột status?).'); return; }
        toast('Đã cập nhật: '+status);
        if(closeModal) document.querySelector('#dlg').close();
        await reload();
      }catch(e){ alert('Lỗi: '+(e.message||e)); }
    }

    /* =========================
       === TỔNG HỢP THIỆT HẠI ===
       ========================= */

    function toNumLoose(x){
      if (x==null) return 0;
      if (typeof x==='number') return isFinite(x)?x:0;
      const s=String(x).replace(/\./g,'').replace(/,/g,'.').replace(/[^\d\.\-]/g,'').trim();
      const v=parseFloat(s); return isFinite(v)?v:0;
    }

    function getRangeFromUI(){
      let d1=$('d1')?.value||'', d2=$('d2')?.value||'';
      const norm=(s)=>/^\d{2}\/\d{2}\/\d{4}$/.test(s)?(s.replace(/(\d{2})\/(\d{2})\/(\d{4})/,'$3-$2-$1')):s;
      const today=new Date(); const yyyy=today.getFullYear(); const mm=String(today.getMonth()+1).padStart(2,'0'); const dd=String(today.getDate()).padStart(2,'0');
      if(!d1) d1=`${yyyy}-${mm}-${dd}`; if(!d2) d2=`${yyyy}-${mm}-${dd}`;
      return { d1:norm(d1), d2:norm(d2) };
    }

    // chuyển payload -> AOA (2D)
    function payloadToAOA(payload){
      if (payload?.aoa && Array.isArray(payload.aoa) && payload.aoa.length) return payload.aoa;
      if (payload?.cells && window.XLSX){
        const addrs=Object.keys(payload.cells);
        if(!addrs.length) return null;
        const pos=addrs.map(a=>{ const rc=XLSX.utils.decode_cell(a); return {r:rc.r,c:rc.c,v:payload.cells[a]}; });
        const maxR=Math.max(...pos.map(p=>p.r)), maxC=Math.max(...pos.map(p=>p.c));
        const aoa=Array.from({length:maxR+1},()=>Array.from({length:maxC+1},()=>'')); 
        pos.forEach(p=>{ aoa[p.r][p.c]=(p.v==null?'':String(p.v)); });
        return aoa;
      }
      return null;
    }

    // Từ 1 AOA “Maubaocao”: rút ra mapping {code -> {row, label, unit}}
    function mapTemplateFromAOA(aoa){
      const map = new Map();
      for (let r=0;r<aoa.length;r++){
        const row = aoa[r]||[];
               const code = (row[1]??'').toString().trim();          // cột B
        const label = (row[2]??'').toString().trim();         // cột C
        const unit = (row[3]??'').toString().trim();          // cột D
        if (code){
          map.set(code, {row:r, label, unit});
        }
      }
      return map;
    }

    // Trích số liệu từ 1 AOA báo cáo: qty (E) & val (F)
    function valuesFromAOA(aoa){
      const qtyByCode = {};
      const valByCode = {};
      for (let r=0;r<aoa.length;r++){
        const row = aoa[r]||[];
        const code = (row[1]??'').toString().trim();   // B = Mã
        if (!code) continue;
        const qty = toNumLoose(row[4]); // E = Số lượng
        const val = toNumLoose(row[5]); // F = Ước giá trị (triệu)
        if (!isNaN(qty)) qtyByCode[code] = (qtyByCode[code]||0) + qty;
        if (!isNaN(val)) valByCode[code] = (valByCode[code]||0) + val;
      }
      return { qtyByCode, valByCode };
    }

    // Xác định thứ tự “khối lớn” theo template xuất hiện
    function majorOrder(templateMap){
      const majors=[];
      for (const [code] of templateMap.entries()){
        if (/^[A-ZĐ]{2,3}$/.test(code)) majors.push(code);
      }
      return majors;
    }

    // ======= Lấy bản mới nhất mỗi xã để tổng hợp =======
    async function fetchLatestReportsForSummary(){
      const info=$('sumInfo');
      const { d1, d2 } = getRangeFromUI();
      if(info) info.textContent=`Đang tải dữ liệu ${d1} → ${d2} …`;

      let q = supabase.from('reports')
        .select('id, created_at, commune_code, user_id, payload, status')
        .order('created_at',{ascending:false})
        .limit(5000);

      if(d1) q=q.gte('created_at', d1+"T00:00:00");
      if(d2) q=q.lte('created_at', d2+"T23:59:59");
      const communeCode = $('communeFilter')?.value;
      if(communeCode) q=q.eq('commune_code', communeCode);
      if($('approvedOnly')?.checked) q=q.eq('status','approved'); // ✅ chỉ tổng hợp báo cáo đã duyệt

      const { data, error } = await q;
      if(error){ alert('Lỗi tải dữ liệu: '+error.message); if(info) info.textContent=''; return []; }

      const pick=new Map(); // lấy bản mới nhất mỗi xã
      for (const r of (data||[])){
        const code=r.commune_code||'__NONE__';
        if(!pick.has(code)) pick.set(code, r);
      }
      const arr=Array.from(pick.values());
      if(info) info.textContent=`Đã lấy ${arr.length} báo cáo mới nhất mỗi xã.`;
      return arr;
    }

    // ======= Dựng workbook bằng XlsxPopulate (giữ format/công thức) =======
    async function buildWorkbookPopulate(reports){
      // Tổng hợp theo code
      const totalsQty = {}, totalsVal = {};
      let countHasAOA = 0;
      for(const r of reports){
        const aoa = payloadToAOA(r.payload);
        if(!aoa) continue;
        countHasAOA++;
        const { qtyByCode, valByCode } = valuesFromAOA(aoa);
        Object.entries(qtyByCode).forEach(([k,v])=> totalsQty[k]=(totalsQty[k]||0)+(v||0));
        Object.entries(valByCode).forEach(([k,v])=> totalsVal[k]=(totalsVal[k]||0)+(v||0));
      }
      if (countHasAOA===0) return null;

      // Tải template gốc (nếu chưa có thì trả null để fallback SheetJS)
      let ab=null;
      try{
        const resp = await fetch('./Baocaogoc.xlsx');
        if(resp.ok) ab = await resp.arrayBuffer();
      }catch(e){ console.warn('Không tìm thấy Baocaogoc.xlsx, chuyển fallback'); }
      if(!ab) return null;

      const wb = await XlsxPopulate.fromDataAsync(ab);
      const sheet = wb.sheet(0); // "Maubaocao"

      // Tìm cột động theo header
      function findColByText(keys, startRow=1, endRow=20){
        keys = keys.map(s=>s.toLowerCase());
        const used = sheet.usedRange();
        const endCol = used ? used.endCell().columnNumber() : 20;
        for (let c=1;c<=endCol;c++){
          for (let r=startRow;r<=endRow;r++){
            const v = (sheet.cell(r,c).value()||'').toString().toLowerCase();
            if (v && keys.some(k=>v.includes(k))) return c;
          }
        }
        return null;
      }
      const colCode = findColByText(['mã','ma']) || 2;
      const colLabel= findColByText(['chỉ tiêu','chi tieu']) || 3;
      const colUnit = findColByText(['đơn vị','don vi']) || 4;
      const colQty  = findColByText(['số lượng','so luong']) || 5;
      const colVal  = findColByText(['ước','gia tri','triệu']) || 6;

      const used = sheet.usedRange();
      const maxRow = used ? used.endCell().rowNumber() : 500;

      // Ghi đè E/F theo mã
      for (let r=1;r<=maxRow;r++){
        const code = (sheet.cell(r,colCode).value()||'').toString().trim();
        if (!code) continue;
        if (!/[A-Za-zĐđ]{2,3}\d*/.test(code)) continue;
        sheet.cell(r,colQty).value(+(totalsQty[code]||0));
        sheet.cell(r,colVal).value(+(totalsVal[code]||0));
      }

      // Wrap + căn chỉnh cột chỉ tiêu
      try {
        const usedRange = sheet.usedRange();
        const maxR = usedRange ? usedRange.endCell().rowNumber() : 500;
        sheet.range(1, colLabel, maxR, colLabel).style({
          wrapText: true,
          horizontalAlignment: "left",
          verticalAlignment: "top"
        });
        for (let r = 1; r <= maxR; r++) {
          const cell = sheet.cell(r, colLabel);
          const mg = cell.merged && cell.merged();
          if (mg) mg.style({ wrapText: true, horizontalAlignment: "left", verticalAlignment: "top" });
        }
      } catch (_) {}

      // Xuất blob
      const blob = await wb.outputAsync();
      return { blob };
    }

    // ======= Fallback build bằng SheetJS =======
    function buildWorkbookSheetJS(reports){
      if(!window.XLSX){ alert('Thiếu thư viện XLSX'); return null; }

      // Tìm AOA đầu tiên hợp lệ
      let templateAOA=null, templateMap=null;
      for(const r of reports){
        const a = payloadToAOA(r.payload);
        if(a && a.length){ templateAOA = a; templateMap = mapTemplateFromAOA(a); break; }
      }
      if(!templateAOA){ return null; }

      const totalsQty={}, totalsVal={};
      for(const r of reports){
        const aoa = payloadToAOA(r.payload); if(!aoa) continue;
        const { qtyByCode, valByCode } = valuesFromAOA(aoa);
        Object.entries(qtyByCode).forEach(([k,v])=> totalsQty[k]=(totalsQty[k]||0)+(v||0));
        Object.entries(valByCode).forEach(([k,v])=> totalsVal[k]=(totalsVal[k]||0)+(v||0));
      }

      const outAOA = templateAOA.map(row=>row.slice());
      for(const [code,meta] of templateMap.entries()){
        const r = meta.row;
        if(outAOA[r]){
          while(outAOA[r].length<6) outAOA[r].push('');
          outAOA[r][4]=+(totalsQty[code]||0);
          outAOA[r][5]=+(totalsVal[code]||0);
        }
      }
      const ws_maubao = XLSX.utils.aoa_to_sheet(outAOA);
      const maxCols = Math.max(...outAOA.map(r=>r.length));
      ws_maubao['!cols']=Array.from({length:maxCols||1},()=>({wch:20}));

      const majors=[];
      for (const [code] of templateMap.entries()){ if (/^[A-ZĐ]{2,3}$/.test(code)) majors.push(code); }
      const rows_m1=[['STT','Mã','Chỉ tiêu','Đơn vị','Số lượng','Giá trị (triệu)']];
      majors.forEach((maj,idx)=>{
        let sumQ=0,sumV=0;
        Object.keys({...totalsQty,...totalsVal}).forEach(code=>{
          if(code.startsWith(maj)&&/\d/.test(code)){ sumQ+=(totalsQty[code]||0); sumV+=(totalsVal[code]||0); }
        });
        const meta=templateMap.get(maj)||{};
        rows_m1.push([String(idx+1),maj,meta.label||('Nhóm '+maj),meta.unit||'',+sumQ,+sumV]);
        for(let i=1;i<=99;i++){
          const code=maj+String(i).padStart(2,'0');
          if(templateMap.has(code)){
            const m1=templateMap.get(code);
            rows_m1.push([`${idx+1}.${i}`,code,m1.label||'',m1.unit||'',+(totalsQty[code]||0),+(totalsVal[code]||0)]);
          }
        }
      });
      const ws_m1=XLSX.utils.aoa_to_sheet(rows_m1);
      ws_m1['!cols']=[{wch:8},{wch:10},{wch:48},{wch:16},{wch:16},{wch:20}];

      const rows_all=[['STT','Mã','Chỉ tiêu','Đơn vị','Số lượng','Giá trị (triệu)']];
      function codeToNoSheetJS(code){
        const m=/^([A-ZĐ]{2,3})(\d+)?$/.exec(code||''); if(!m) return '';
        const idx=majors.indexOf(m[1])+1; if(idx<=0) return '';
        if(!m[2]) return String(idx);
        const d=m[2]; const parts=[String(idx),String(parseInt(d.slice(0,2),10))];
        for(const ch of d.slice(2)) parts.push(String(parseInt(ch,10)));
        return parts.join('.');
      }
      for(const [code,meta] of templateMap.entries()){
        if(!/[0-9]/.test(code)) continue;
        rows_all.push([codeToNoSheetJS(code),code,meta.label||'',meta.unit||'',+(totalsQty[code]||0),+(totalsVal[code]||0)]);
      }
      const ws_all=XLSX.utils.aoa_to_sheet(rows_all);
      ws_all['!cols']=[{wch:10},{wch:10},{wch:48},{wch:16},{wch:16},{wch:20}];

      const wb=XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb,ws_maubao,'Maubaocao');
      XLSX.utils.book_append_sheet(wb,ws_m1,'MucLon');
      XLSX.utils.book_append_sheet(wb,ws_all,'MucLon_ChiTiet');
      return wb;
    }

    // ======= JSON tổng hợp =======
    function exportSummaryJSONFromReports(reports){
      const details=[];
      const totalsQty={}, totalsVal={};
      let countHasAOA = 0;
      for(const r of reports){
        const aoa = payloadToAOA(r.payload);
        if(!aoa) continue;
        countHasAOA++;
        const { qtyByCode, valByCode } = valuesFromAOA(aoa);
        details.push({
          commune_code: r.commune_code || '',
          commune_name: communeByUser.get(r.user_id)||communeByCode.get(r.commune_code)||'',
          created_at: r.created_at,
          qtyByCode, valByCode
        });
        Object.entries(qtyByCode).forEach(([k,v])=> totalsQty[k]=(totalsQty[k]||0)+(v||0));
        Object.entries(valByCode).forEach(([k,v])=> totalsVal[k]=(totalsVal[k]||0)+(v||0));
      }
      return { meta:{generated_at:new Date().toISOString(), communes: details.length, valid_reports: countHasAOA}, totals:{ qty: totalsQty, value: totalsVal }, details };
    }

    // ======= Nút xuất Excel / JSON =======
    $('btnExportSummaryXLSX').addEventListener('click', async ()=>{
      try{
        $('sumInfo').textContent='Đang tổng hợp…';
        await waitForXLSX(); // ✅ đảm bảo XLSX đã sẵn sàng
        const reports = await fetchLatestReportsForSummary();
        if(!reports.length){ $('sumInfo').textContent='Không có báo cáo trong khoảng thời gian đã chọn.'; return; }

        // Thử dùng XlsxPopulate với template gốc (nếu có)
        let blob = null;
        try{
          const res = await buildWorkbookPopulate(reports);
          if(res && res.blob) blob = res.blob;
        }catch(e){ console.warn('Populate export failed, chuyển fallback', e); }

        if (blob){
          const d=new Date();
          const fn = `TongHop_ThietHai_${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}_${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}.xlsx`;
          const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=fn; a.click();
          $('sumInfo').textContent='Đã xuất Excel (theo template gốc).';
          return;
        }

        // Fallback: SheetJS
        const wb = buildWorkbookSheetJS(reports);
        if (wb){
          const d=new Date();
          const fn = `TongHop_ThietHai_${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}_${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}.xlsx`;
          XLSX.writeFile(wb, fn);
          $('sumInfo').textContent='Đã xuất Excel (fallback).';
        } else {
          $('sumInfo').textContent='Không tìm thấy payload dạng bảng để tổng hợp (aoa/cells).';
          alert('Không có payload dạng bảng (aoa/cells). Mở “Xem chi tiết” để kiểm tra các báo cáo.');
        }
      }catch(e){
        console.error('ExportSummaryXLSX error', e);
        $('sumInfo').textContent='Lỗi tổng hợp.';
        alert('Lỗi tổng hợp: ' + (e.message || e));
      }
    });

    $('btnExportSummaryJSON').addEventListener('click', async ()=>{
      try{
        $('sumInfo').textContent='Đang tổng hợp…';
        await waitForXLSX(); // an toàn khi cần decode_cell
        const reports = await fetchLatestReportsForSummary();
        if(!reports.length){ $('sumInfo').textContent='Không có báo cáo trong khoảng thời gian đã chọn.'; return; }
        const payload = exportSummaryJSONFromReports(reports);
        const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
        const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='tonghop.json'; a.click();
        $('sumInfo').textContent='Đã xuất JSON.';
      }catch(e){
        console.error('ExportSummaryJSON error', e);
        $('sumInfo').textContent='Lỗi tổng hợp JSON.';
        alert('Lỗi tổng hợp JSON: ' + (e.message || e));
      }
    });

  </script>
</body>
</html>
